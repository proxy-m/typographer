<!DOCTYPE html>
<html>
<head>
 <title>Typographer: Convert Spaces to nbsp</title>
 <script type="text/javascript">
     let fileDisplayArea = null;
     let pauseR = false;
     
  function displayFile () {
   var fileInput = document.getElementById('fileInput');
   fileDisplayArea = document.getElementById('fileDisplayArea');

   var file = fileInput.files[0];
   var reader = new FileReader();

   reader.onload = function(e) {
       fileDisplayArea.innerHTML = '';
       fileDisplayArea.value = e.target.result;
       
       fileInput.value = fileInput.defaultValue;
       convertSpaces();
   }

   reader.readAsText(file);
  }

  function convertSpaces () {
      if (pauseR) {
          return;
      }
   fileDisplayArea = document.getElementById('fileDisplayArea');
   var text = fileDisplayArea.value;
   
   if (!text || !text.trim || !text.trim().length) {
       console.warn('No input text!');
       return;
   }
   
   var textArr = (text.trim().replaceAll('\t', '    ').replaceAll('\r', '\n').replaceAll('\n', ' \n ').replaceAll('&amp;', '&').replaceAll('&nbsp;', ' ').replaceAll('<br>', '\n').replaceAll('<br/>', '\n').replaceAll('<BR>', '\n').replaceAll('<BR/>', '\n')/*.replace(/ +/g, ' ')*/).split(' ');
   ///textArr = textArr.filter(function (e) { return !!e; });
   
   //console.log(textArr);
   
   let wasLineBreak = false;
   var textNewArr;
   textNewArr = textArr.map(function (e, i) {
       if (!e || !e.trim || !e.trim().length || e.indexOf('\n') >= 0 || e.endsWith(',') || e.endsWith('.') || e.endsWith('!') || e.endsWith('?') || e.endsWith(':') || e.endsWith(';')) {
           wasLineBreak = true;
       } else {
           wasLineBreak = false;
       }
       if (!wasLineBreak && e.length <= (document.getElementById('prepositionWorldLen').value || 3) && (''+e) != (''+(+e))) {
           e = e + '&nbsp;';
           //console.log(e);
       } else if (wasLineBreak && !!e && !!e.trim && e.length >= 2 && ' ' === e[e.length - 2] && (e.endsWith(',') || e.endsWith('.') || e.endsWith('!') || e.endsWith('?') || e.endsWith(':') || e.endsWith(';'))) {
           e = e.substring(0, e.length - 1) + '&nbsp;' + e.substring(e.length - 1);
       }
       return e;
   });
   
   //console.log('textNewArr: ', textNewArr);

   
   var convertedText = textNewArr.join(' ').replace(/ \n /g, '\n').replace(/[&][n][b][s][p][;][ ]/g, '&nbsp;');
   convertedText = convertedText.replaceAll('\n', !!document.getElementById('brInsteadN').checked ? '<br/>' : '\n');
   
   fileDisplayArea.innerHTML = '';
   fileDisplayArea.value = convertedText;
   
   displayAfterConvert();
   
   navigator.clipboard.writeText(convertedText);
   document.getElementById('fileDisplayArea').placeholder = 'RESULT ALREADY IN CLIPBOARD (BUFFERED)';
  }
  
  function displayAfterConvert () {
      if (pauseR) {
          return;
      }
      if (!!document.getElementById('output')) {
            document.getElementById('output').outerHTML = '';
      }
      
      
      
      document.body.insertAdjacentHTML('beforeend', '<div id="output" style="width: 50%; height: auto;">' + (document.getElementById('fileDisplayArea').value.replace(/[&][a][m][p][;][n][b][s][p][;]/g, '\u00A0').replaceAll('\u00A0', '&nbsp;').replaceAll('&nbsp;', '\u00A0').replaceAll('\n', '<br/>')) + '</div>');
      console.log(2);
  }
  
  function selectElementContents (el) {
        var range;
        if (window.getSelection && document.createRange) {
            range = document.createRange();
            var sel = window.getSelection();
            range.selectNodeContents(el);
            sel.removeAllRanges();
            sel.addRange(range);
        } else if (document.body && document.body.createTextRange) {
            range = document.body.createTextRange();
            range.moveToElementText(el);
            range.select();
        }
  }
  
  document.addEventListener('keydown', function (e) {
      if ((e.ctrlKey || e.metaKey) && (e.key === 'a' || e.key === 'A' || String.fromCharCode(e.which || e.keyCode).toLowerCase() === 'a')) {
          if (!e.target.placeholder) {
              return;
          }
          e.preventDefault();
          console.log('CTRL + A');
          e.target.select();  //selectElementContents(e.target);
          
          pauseR = true;
          
          //setTimeout(function () {
              
            var ke1 = document.createEvent("Events");
            ke1.initEvent("keydown", true, true);
            ke1.keyCode = ke1.which = 8; // Backspace
            e.target.dispatchEvent(ke1);

            var ke2 = document.createEvent("Events");
            ke2.initEvent("keyup", true, true);
            ke2.keyCode = ke2.which = 8; // Backspace
            e.target.dispatchEvent(ke2);
         //}, 5000);
      } else if (8 === +e.keyCode && pauseR) { // Backspace
          e.preventDefault();
          console.log(e.keyCode);
          
          pauseR = true;
          
          if (window.getSelection) {
              if (window.getSelection().toString() != '') {
                window.getSelection().deleteFromDocument();
                document.getElementById('fileDisplayArea').innerHTML = '';  document.getElementById('fileDisplayArea').value = '';
              }
              
              if (window.getSelection().empty) {  // Chrome
                window.getSelection().empty();
              } else if (window.getSelection().removeAllRanges) {  // Firefox
                window.getSelection().removeAllRanges();
              }
          } else if (document.selection) {  // IE?
              document.selection.deleteFromDocument(); //
              document.getElementById('fileDisplayArea').innerHTML = '';  document.getElementById('fileDisplayArea').value = '';
              
              document.selection.empty();
          }
                    
          document.getElementById('fileDisplayArea').blur();
          
          setTimeout(function() {
              fileDisplayArea = document.getElementById('fileDisplayArea');
              fileDisplayArea.parentElement.focus();
              fileDisplayArea.focus();
              pauseR = false;
          }, 10);
      }
      
      setTimeout(function() {
          pauseR = false;
      }, 20);
      
  });
  
  let wasStarted = false;
  setTimeout(function update () {
      if (wasStarted) {
          return;
      }
      wasStarted = true;
      try {
          convertSpaces();
      } catch (e) {
      } finally {
          wasStarted = false;
      }
  }, 100);
 </script>
</head>
<body>
 <h1 style="color: lightgrey;">Typographer: Convert Spaces to nbsp</h1>

 <input type="number" id="prepositionWorldLen" value="3" style="width: 30px;" onchange="document.getElementById('fileDisplayArea').innerHTML = '';  document.getElementById('fileDisplayArea').value = '';" />
 <label for="prepositionWorldLen" title="–î–ª–∏–Ω–∞ –ø—Ä–µ–¥–ª–æ–≥–∞ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è)">Preposition world length (maximum)</label>
 
 <input type="checkbox" id="brInsteadN" style="width: 30px;" onchange="convertSpaces();" />
 <label for="brInsteadN">Use html BR instead N (new line)</label>

 <input type="file" id="fileInput" onchange="displayFile()" style="display:none;">
 <label for="fileInput" style="cursor: pointer;"><h3>üìÅ [Press here]‚ñ≠ Open file or paste text</h3></label>
 

<!-- –£ –ª–µ—Å–∞ –Ω–∞ –æ–ø—É—à–∫–µ –∂–∏–ª–∞ –ó–∏–º–∞ –≤ –∏–∑–±—É—à–∫–µ.	–û–Ω–∞ —Å–Ω–µ–∂–∫–∏ —Å–æ–ª–∏–ª–∞ –≤ –±–µ—Ä–µ–∑–æ–≤–æ–π –∫–∞–¥—É—à–∫–µ,	–û–Ω–∞ —Å—É—á–∏–ª–∞ –ø—Ä—è–∂—É, –æ–Ω–∞ —Ç–∫–∞–ª–∞ —Ö–æ–ª—Å—Ç—ã	–ö–æ–≤–∞–ª–∞ –ª–µ–¥—è–Ω—ã–µ –¥–∞ –Ω–∞–¥ —Ä–µ–∫–∞–º–∏ –º–æ—Å—Ç—ã.		–ü—Ä–∏–ø–µ–≤:	–ü–æ—Ç–æ–ª–æ–∫ –ª–µ–¥—è–Ω–æ–π, –¥–≤–µ—Ä—å —Å–∫—Ä–∏–ø—É—á–∞—è,	–ó–∞ —à–µ—Ä—à–∞–≤–æ–π —Å—Ç–µ–Ω–æ–π —Ç—å–º–∞ –∫–æ–ª—é—á–∞—è.	–ö–∞–∫ —à–∞–≥–Ω–µ—à—å –∑–∞ –ø–æ—Ä–æ–≥ - –≤—Å—é–¥—É –∏–Ω–µ–π,	–ê –∏–∑ –æ–∫–æ–Ω –ø–∞—Ä–æ–∫ —Å–∏–Ω–∏–π-—Å–∏–Ω–∏–π.		–•–æ–¥–∏–ª–∞ –Ω–∞ –æ—Ö–æ—Ç—É, –∫–æ–≤–∞–ª–∞ —Å–µ—Ä–µ–±—Ä–æ,	–°–∞–∂–∞–ª–∞ —Ç–æ–Ω–∫–∏–π –º–µ—Å—è—Ü –≤ —Ö—Ä—É—Å—Ç–∞–ª—å–Ω–æ–µ –≤–µ–¥—Ä–æ.	–î–µ—Ä–µ–≤—å—è–º —à—É–±—ã —à–∏–ª–∞, —Ç–æ—Ä–∏–ª–∞ —Å–∞–Ω–Ω—ã–π –ø—É—Ç—å,	–ê –ø–æ—Å–ª–µ –≤ –ª–µ—Å —Å–ø–µ—à–∏–ª–∞, —á—Ç–æ–± –≤ –∏–∑–±—É—à–∫–µ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å.		–ü—Ä–∏–ø–µ–≤:	–ü–æ—Ç–æ–ª–æ–∫ –ª–µ–¥—è–Ω–æ–π, –¥–≤–µ—Ä—å —Å–∫—Ä–∏–ø—É—á–∞—è,	–ó–∞ —à–µ—Ä—à–∞–≤–æ–π —Å—Ç–µ–Ω–æ–π —Ç—å–º–∞ –∫–æ–ª—é—á–∞—è.	–ö–∞–∫ —à–∞–≥–Ω–µ—à—å –∑–∞ –ø–æ—Ä–æ–≥ - –≤—Å—é–¥—É –∏–Ω–µ–π,	–ê –∏–∑ –æ–∫–æ–Ω –ø–∞—Ä–æ–∫ —Å–∏–Ω–∏–π-—Å–∏–Ω–∏–π. -->

 <textarea id="fileDisplayArea" autofocus placeholder="" rows="10" cols="50" onchange="convertSpaces();"></textarea>

 <button onclick="convertSpaces();">Convert and Copy</button>
 
 <div id="output" style="width: 50%; height: auto;"></div>

</body>
</html>
